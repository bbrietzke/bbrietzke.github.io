<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title></title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introductions"><a class="header" href="#introductions">Introductions</a></h1>
<p>So this is my collection of thoughts, ideas and craziness documented for everyone to see.  I have a lot of different interests that I cycle through irregularly.  It's hard to keep track of the bits and pieces so I figure I should write some of this down.</p>
<p>I don't like blogging, much to much like trying to keep a journal or a dairy ( not that there is anything wrong in that ).  Instead I have specific, task-focused documents that I want to keep around so that when I revisit a topic, I can pick up where I left off.</p>
<p>If others find my documents and notes of interest, then that's great.  That is not the reason why I'm doing this though.</p>
<p>If folks have suggestions or corrections, then great!  Create a fork, branch and submit a PR.  I don't mind being corrected and giving credit where credit is due.  I'm not right all the time and there are much more knowledgable folks out there then me.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="kubernetes"><a class="header" href="#kubernetes">Kubernetes</a></h1>
<p><a href="https://kubernetes.io/">Kubernetes</a> is a big deal, and is something that I enjoy using.</p>
<p>I have decided to document my kubernetes setup so that other folks can follow along and see what I have
going on, and maybe learn a thing or two along the way.  It is also documented because I tend to rebuild
the mess every couple of months and I usually forget something along the way!</p>
<h2 id="order-of-operations"><a class="header" href="#order-of-operations">Order of Operations</a></h2>
<ul>
<li><a href="kube/installation.html">Installation</a></li>
<li><a href="kube/local_setup.html">Local Setup</a></li>
<li><a href="kube/add_worker.html">Add Worker Node</a></li>
<li><a href="kube/certmanager.html">Certificate Manager</a></li>
<li><a href="kube/nfs_provisioner.html">NFS Provisioner</a></li>
<li><a href="kube/metrics_server.html">Metrics Server</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="installing-kubernetes"><a class="header" href="#installing-kubernetes">Installing Kubernetes</a></h1>
<p>This is for a single host installation.  I'll include instructions for adding an additional host down the line if you are so inclined.</p>
<p>I have consolidated a number of different documents, mostly for the troubleshooting.</p>
<h2 id="setup"><a class="header" href="#setup">Setup</a></h2>
<p>This is for installation on an Ubuntu 24.04 LTS machine.  I would recommend a machine with at least 8GiB of RAM, 16GiB of hard drive space and at least two cores.  The more the better things will run and the more stuff you can cram into Kubernetes.</p>
<p>Make sure your server is up to date before we get started.</p>
<pre><code>sudo apt update &amp;&amp; sudo apt full-upgrade -y 
</code></pre>
<h2 id="step-by-step"><a class="header" href="#step-by-step">Step By Step</a></h2>
<h3 id="step-one-disable-swap"><a class="header" href="#step-one-disable-swap">Step One: Disable Swap</a></h3>
<p><strong>Kubeadm</strong> will complain if swap is enabled, so let's disable able that.</p>
<pre><code>sudo swapoff -a
</code></pre>
<h3 id="step-two-kernel-parameters"><a class="header" href="#step-two-kernel-parameters">Step Two: Kernel Parameters</a></h3>
<p>There are some parameters that need to be tuned in the linux kernel for Kubernetes to work properly.</p>
<pre><code>sudo tee /etc/modules-load.d/containerd.conf &lt;&lt; EOF
overlay
br_netfilter
EOF
</code></pre>
<pre><code>sudo tee /etc/sysctl.d/kubernetes.conf &lt;&lt; EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1
EOF
</code></pre>
<pre><code>sudo modprobe overlay &amp;&amp; sudo modprobe br_netfilter &amp;&amp; sudo sysctl --system
</code></pre>
<h3 id="step-three-container-runtime-installation"><a class="header" href="#step-three-container-runtime-installation">Step Three: Container Runtime Installation</a></h3>
<p>Let's install <strong>containerd</strong>.</p>
<pre><code>sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmour -o /etc/apt/trusted.gpg.d/docker.gpg &amp;&amp; \
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" &amp;&amp; \
sudo apt update &amp;&amp; \
sudo apt install -y containerd.io
</code></pre>
<p>Need to have a configuration file for <strong>containerd</strong>.  Luckily, we can generate one.</p>
<pre><code>containerd config default | sudo tee /etc/containerd/config.toml &gt;/dev/null 2&gt;&amp;1 
sudo sed -i 's/SystemdCgroup \= false/SystemdCgroup \= true/g' /etc/containerd/config.toml
</code></pre>
<p>Then we'll need to enable and restart <strong>containerd</strong>.</p>
<pre><code>sudo systemctl enable containerd &amp;&amp; \
sudo systemctl restart containerd
</code></pre>
<h3 id="step-four-kubernetes-runtime-installation"><a class="header" href="#step-four-kubernetes-runtime-installation">Step Four: Kubernetes Runtime Installation</a></h3>
<p>This will install kubernetes 1.34 to be installed on the machine.  At the time of writing, it is the most current version.</p>
<pre><code>curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.34/deb/Release.key | sudo gpg  --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg &amp;&amp; \
echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.34/deb/ /" | sudo tee /etc/apt/sources.list.d/kubernetes.list &amp;&amp; \
sudo apt update &amp;&amp; \
sudo apt install -y kubelet kubeadm kubectl
</code></pre>
<h3 id="step-five-kubeadm-execution"><a class="header" href="#step-five-kubeadm-execution">Step Five: Kubeadm Execution</a></h3>
<p>Now for the part that we've all been waiting for! The prerequisites are in place so now it's time to get kubernetes up and running.</p>
<pre><code>sudo kubeadm init
</code></pre>
<p>This will take a little while to run.</p>
<h3 id="step-six-tool-configuration"><a class="header" href="#step-six-tool-configuration">Step Six: Tool Configuration</a></h3>
<p>Once the installation is complete, you will need to configure <strong>kubectl</strong>.  Execute the following:</p>
<pre><code>mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
</code></pre>
<p>This will copy the configuration to your home directory.  This will allow you to use  <strong>kubectl</strong> from anywhere on the system.</p>
<h3 id="step-seven-remove-the-taints"><a class="header" href="#step-seven-remove-the-taints">Step Seven: Remove the Taints</a></h3>
<p>This is a single node system, which means that it's also running as a control panel.  Normally, kubernetes doesn't want additional pods on the control panel, which makes for an interesting catch-22.  Thankfully, we can fix that.</p>
<pre><code>kubectl taint nodes --all node-role.kubernetes.io/control-plane-
</code></pre>
<h3 id="step-eight-container-networking"><a class="header" href="#step-eight-container-networking">Step Eight: Container Networking</a></h3>
<p>In order for the node to become <em>ready</em>, it will need networking installed. For simple, one node installs I personally think Calico is perfectly reasonable.</p>
<pre><code>kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.30.3/manifests/calico.yaml
</code></pre>
<p>It will take a little bit for the networking jitters to settle.</p>
<h3 id="step-nine-does-it-work"><a class="header" href="#step-nine-does-it-work">Step Nine: Does it work?</a></h3>
<p>Let's pull up the cluster information</p>
<pre><code>kubectl cluster-info
</code></pre>
<p>Do all nodes show <strong>READY</strong>?</p>
<pre><code>kubectl get nodes -o wide
</code></pre>
<p>What do the pods look like?</p>
<pre><code>kubectl get pods -o wide -A
</code></pre>
<h3 id="step-ten-install-something"><a class="header" href="#step-ten-install-something">Step Ten: Install Something!</a></h3>
<p>You can also create a very basic <em>nginx</em> deployment just to see if things work.</p>
<pre><code>kubectl apply -f https://gist.githubusercontent.com/bbrietzke/c59b6132c37ea36f9b84f1fee701a642/raw/952524cec7892e9db350fc62773c32ddfd9ab867/kubernetes-test.yaml
</code></pre>
<p>Then:</p>
<pre><code>open http://kubernetes-host.local:30081/
</code></pre>
<p>And you should see a website in the browser of your choice.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="local-setup"><a class="header" href="#local-setup">Local Setup</a></h1>
<p>There are some tools that I like to have on my local machine that makes working with Kubernetes much easier.
This document will go through the installation and configuration of them.</p>
<h2 id="what-to-install"><a class="header" href="#what-to-install">What to install?</a></h2>
<p>Since I'm on a Mac, everything is installed through (Homebrew)[https://brew.sh/].</p>
<pre><code>brew install k9s helm kubernetes-cli
</code></pre>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<h3 id="kubernetes-tools"><a class="header" href="#kubernetes-tools">Kubernetes Tools</a></h3>
<p>The only thing that <em>really</em> needs configuration is the kubernetes configuration tools.  For that, you need to get
a copy of the kube config file from the control-plane.</p>
<pre><code>mkdir ~/.kube
scp ubuntu@basil.local:.kube/config ~/.kube/config
</code></pre>
<p>This configures both <strong>k9s</strong> and <strong>kubectl</strong>, so that bit is done.  Both of the tools should work as you would expect.</p>
<h3 id="helm"><a class="header" href="#helm">Helm</a></h3>
<p>You don't <em>have</em> to configure <strong>helm</strong>, but it's not a bad idea either.  My personal chart repository is configured as follows.</p>
<pre><code>helm repo add bbrietzke http://bbrietzke.github.io/charts
</code></pre>
<p>I have a few charts that I tend to use, in particular for setting up namespaces.  I have three, <em>prod</em>, <em>dev</em>, and <em>infra</em>.  There isn't much else to customize, so this just works.</p>
<pre><code>helm install namespaces bbrietzke/namespaces
</code></pre>
<p>It's also the first helm chart I created.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="adding-a-worker-node"><a class="header" href="#adding-a-worker-node">Adding a Worker Node</a></h1>
<p>On the control plane, all you need is:</p>
<pre><code>kubeadm token create --print-join-command
</code></pre>
<p>Just copy and paste that over to the new worker node and it will do the rest.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="managing-certificates-in-kubernetes"><a class="header" href="#managing-certificates-in-kubernetes">Managing Certificates in Kubernetes</a></h1>
<p>Dealing with TLS certificates is a pain in butt!</p>
<p>This document is just a reshash/shorten view with my specific configuration.  You can find the full documentation over <a href="https://cert-manager.io/">at cert-manager.io</a>.</p>
<h2 id="installation"><a class="header" href="#installation">Installation</a></h2>
<h3 id="helm-1"><a class="header" href="#helm-1">Helm</a></h3>
<pre><code>helm repo add jetstack https://charts.jetstack.io &amp;&amp; helm repo update
</code></pre>
<p>There are a number of ancilliary resources that have to be installed.  You can do it manually, or let the helm chart do it ( which is what I did ).</p>
<pre><code>helm install \
  cert-manager jetstack/cert-manager --namespace cert-manager --create-namespace --version v1.11.0 --set installCRDs=true
</code></pre>
<p>Go over <a href="https://cert-manager.io/docs/installation/verify/">verify section on the official docs</a> to make sure it's working.</p>
<h2 id="configuration-1"><a class="header" href="#configuration-1">Configuration</a></h2>
<p>You have to create <strong>issuers</strong> per namespace that will actually create and distribute the certificates.  It's one of those resources that you
created when you installed the helm charts.</p>
<h3 id="self-signed"><a class="header" href="#self-signed">Self-Signed</a></h3>
<p>I created self-signed certificates for my namespaces just because.</p>
<p>Here is an example CRD:</p>
<pre><code>apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: dev-selfsigned-issuer
  namespace: dev
spec:
  selfSigned: {}
</code></pre>
<p>I'm sure I'll write up a Helm chart at somepoint with the issuers that I need.</p>
<h2 id="using-the-certificate-manager"><a class="header" href="#using-the-certificate-manager">Using the Certificate Manager</a></h2>
<p>The certificates are mostly used by your ingress controllers to prove that the domain is valid and encrypt the communications between
the origin and the client.  I'm sure that can be used else where, but this is the scenerio that I use them for.</p>
<p>You will need to modify the ingress resource defination to be similiar to:</p>
<pre><code>...
kind: Ingress
metadata:
    namespace: dev
    annotation:
        cert-manager.io/issuer: dev-selfsigned-issuer
...
</code></pre>
<p>The namespace must match the name of the issuer for that namespace.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nfs-persistent-volumes"><a class="header" href="#nfs-persistent-volumes">NFS Persistent Volumes</a></h1>
<p>Do your pods need to have persitent volumes for your home Kubernetes cluster?  Turns out, NFS is an option</p>
<p>https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner</p>
<h2 id="helm-charts"><a class="header" href="#helm-charts">Helm Charts</a></h2>
<p>You can add the helm chart with:</p>
<pre><code>helm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/
</code></pre>
<p>Then always pull the values, since you will need to customize the NFS server IP and path</p>
<pre><code>helm show values nfs-subdir-external-provisioner/nfs-subdir-external-provisioner
</code></pre>
<p>An example customized one looks like the following:</p>
<pre><code>nfs:
  server: 10.0.0.155
  path: /srv/nfs_shares/kubernetes
</code></pre>
<p>And of course, we have to provision:</p>
<pre><code>helm install -f nfs_prov.yml nfs-provisioner nfs-subdir-external-provisioner/nfs-subdir-external-provisioner -n infra
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><p>Metrics server is not quite as easy to install as advertise, at least on system installed with <code>kubeadm</code>.  But, the fix to make
it work is pretty simple, assuming you do it the insecure way.</p>
<p>The correct way is more complicated, but also secure.</p>
<h2 id="installing"><a class="header" href="#installing">Installing</a></h2>
<p>The code and instructions to install metrics server <a href="https://github.com/kubernetes-sigs/metrics-server">can be found here</a>.  Again, not repeating them here so they go stale.</p>
<p>The instructions work perfectly, things get installed and then don't work.  At all.</p>
<p>The metrics pod just never becomes ready and then logs complain about SSL certificates being invalid.</p>
<h2 id="cheating-and-being-insecure"><a class="header" href="#cheating-and-being-insecure">Cheating and Being Insecure</a></h2>
<p>The easiest option is to add <code>--kubelet-insecure-tls</code> to the spec.container.args array.  I added it as the last one.</p>
<p>You can make this edit either in the deployment or prior to doing a <code>kubectl apply</code> if you download the manifest files.</p>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><h1 id="raid-arrays"><a class="header" href="#raid-arrays">RAID Arrays</a></h1>
<p>Let's build a few different kinds of RAID arrays and then use them.</p>
<p>I'm not going to go into detail about what RAID is, or the different levels since there is plenty of documentation
out there already.  These are the commands to setup software RAID for Linux and the general workflow to follow.</p>
<h2 id="do-we-have-any-now"><a class="header" href="#do-we-have-any-now">Do we have any now?</a></h2>
<p>Let's just double check</p>
<pre><code>cat /proc/mdstat
</code></pre>
<h2 id="okay-which-devices"><a class="header" href="#okay-which-devices">Okay, which Devices?</a></h2>
<p>Insert the new drives into the machine.  You <em>should</em> know what the come up as, but if you don't, try:</p>
<pre><code>lsblk
</code></pre>
<p>That should get you a list of all the block devices on the system and where they are being used at.  Some of them
don't make sense, but you should see the ones that you just added.  If needed, run the command and copy down the results.
Then insert the drives and execute it again.</p>
<p>I'll be using the following:</p>
<pre><code>/dev/sda
/dev/sdb
/dev/sdc
/dev/sdd
</code></pre>
<h2 id="create-the-arrays"><a class="header" href="#create-the-arrays">Create the ARRAYS!</a></h2>
<h3 id="raid-0"><a class="header" href="#raid-0">RAID 0</a></h3>
<p>We'll start with RAID 0, since it will allow us to use all the drives as one big ( though not redundant ) block device.</p>
<pre><code>sudo mdadm --create --verbose /dev/md0 --level=raid0 --raid-devices=4 /dev/sda /dev/sdb /dev/sdc /dev/sdd
</code></pre>
<h3 id="raid-1"><a class="header" href="#raid-1">RAID 1</a></h3>
<p>Simple mirroring.  The easiest to use, a decent redundancy package and not all that wasteful.</p>
<pre><code>sudo mdadm --create --verbose /dev/md0 --level=raid1 --raid-devices=2 /dev/sda /dev/sdb
</code></pre>
<h3 id="raid-5"><a class="header" href="#raid-5">RAID 5</a></h3>
<p>Probably the best all around choice.  Best use of capacity and good performance.</p>
<pre><code>sudo mdadm --create --verbose /dev/md0 --level=raid5 --raid-devices=4 /dev/sda /dev/sdb /dev/sdc /dev/sdd
</code></pre>
<h2 id="creating-the-filesystem"><a class="header" href="#creating-the-filesystem">Creating the FileSystem</a></h2>
<pre><code>sudo mkfs -t ext4 /dev/md0
</code></pre>
<h2 id="mounting"><a class="header" href="#mounting">Mounting</a></h2>
<p>You should have these drives come up every time you want to use them, so add the entries to <code>/etc/fstab</code>.</p>
<p>First you need the UUID of the array.</p>
<pre><code>sudo blkid /dev/md0
</code></pre>
<p>Take the UUID and the following string and open up <code>/etc/fstab</code> to add something along the lines of:</p>
<pre><code>UUID=655d2d3e-ab31-49c7-9cc3-583ec81fd316 /srv ext4 defaults 0 0
</code></pre>
<p>Then you can execute <code>sudo mount -a</code> and have the array appear where you wanted it.</p>
<h2 id="update-config"><a class="header" href="#update-config">Update config</a></h2>
<pre><code>sudo mdadm --detail --scan | sudo tee -a /etc/mdadm/mdadm.conf
</code></pre>
<p>then</p>
<pre><code>sudo update-initramfs -u
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="destroying-raid-arrays"><a class="header" href="#destroying-raid-arrays">Destroying RAID Arrays</a></h1>
<p>You create RAID drives, so you should know who to tear them down.</p>
<p>So we built a few RAID arrays and mounted them, so that's grand.  Now let's tear them down.</p>
<h2 id="unmount-everything"><a class="header" href="#unmount-everything">Unmount everything</a></h2>
<p>Make sure you have the arrays unmounted from there normal ( or abnormal ) paths.  If you don't, not much of
this is going to work out well.</p>
<h2 id="check-mdstat"><a class="header" href="#check-mdstat">Check mdstat</a></h2>
<p>Lets check to see which arrays we currently have configured.</p>
<pre><code>cat /proc/mdstat
</code></pre>
<p>The above should return any arrays you current have built and what state they are in.  In this case, we
need to know the names of the arrays so that we can remove them.</p>
<h2 id="remove-arrays"><a class="header" href="#remove-arrays">Remove Arrays</a></h2>
<p>Okay, let's stop the arrays.</p>
<pre><code>mdadm --stop /dev/md127  # or whatever was returned above
</code></pre>
<p>Now that we don't have working arrays, we can zero them out so that they are empty.</p>
<pre><code>mdadm --zero-superblock /dev/sda /dev/sdb /dev/sdc /dev/sdd
</code></pre>
<h2 id="trust-but-verify"><a class="header" href="#trust-but-verify">Trust, but Verify</a></h2>
<p>Rerun the mdstat and make sure those pesky things are gone.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="custom-host-publishing"><a class="header" href="#custom-host-publishing">Custom Host Publishing</a></h1>
<p>If you're like me, you probably have <strong>AVAHI</strong> running on all your servers just to make name resolution simplier.  What you <em>probably</em> didn't know is you can do some neat tricks with Avahi.</p>
<h2 id="neat-trick-number-one"><a class="header" href="#neat-trick-number-one">Neat Trick Number One</a></h2>
<p>There is a command call <code>avahi-publish</code> that will publish a hostname on your network.  This is pretty cool, because it means you don't have to remember to add the hostname to your hosts file.  It also means you can use this to publish a hostname on a server that doesn't have Avahi installed.</p>
<p>For example:</p>
<pre><code>avahi-publish -a -R pandora.local 192.168.1.10 # or what-ever IP address that you want...
</code></pre>
<p>Now you can <code>ping pandora.local</code> and it will respond!</p>
<p>What good is this? Imagine giving your router an avahi registered name and you can log into it without having to remember the IP. If you're on Xfinity, you can do:</p>
<pre><code>avahi-publish -a -R router.local 10.0.0.1
</code></pre>
<p>You will be able to <code>ping router.local</code> and it will respond!</p>
<h2 id="neat-trick-number-two"><a class="header" href="#neat-trick-number-two">Neat Trick Number Two</a></h2>
<p>So pinging a router by name is nice and all, but not really <em>that</em> exciting.</p>
<p>What you can do is combine the above with Kubernetes' ingress resource definations to have multiple ingress' on the same host without having to anything magical to DNS.</p>
<h2 id="neat-trick-number-three"><a class="header" href="#neat-trick-number-three">Neat Trick Number Three</a></h2>
<p>Again, neat-o and all, but now you have a terminal up and running hosting names and that's just a waste of energy.  What if the terminal window closes or the machine resets? Then you have to manually execute the commands to get the network back online.</p>
<p>Systemd to the rescue!</p>
<pre><code>[Unit]
Description=Avahi OwnCloud

[Service]
ExecStart=/usr/bin/avahi-publish -a -R pandora.local 10.0.0.238
Restart=always

[Install]
WantedBy=default.target
</code></pre>
<p>Save the file in <code>/etc/systemd/system</code> ( i.e. /etc/systemd/system/avahi-pandora.service ).  Then treat it as any normal service.</p>
<pre><code>sudo systemctl enable avahi-pandora
sudo systemctl start avahi-pandora
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="systems-and-application-monitoring-with-prometheus"><a class="header" href="#systems-and-application-monitoring-with-prometheus">Systems and Application Monitoring with Prometheus</a></h1>
<p>Trying to figure out what is going on when something is broke can be hard, so it's nice to have tooling to help with that.  Prometheus is one such tool.  It can also, with proper tuning and work, tell you before something is going to break.</p>
<p>And it make pretty graphs.  Everybody loves pretty graphs!</p>
<h2 id="prometheus"><a class="header" href="#prometheus">Prometheus?</a></h2>
<p>Prometheus monitoring solution is a free and open-source solution for monitoring metrics, events, and alerts. It collects and records metrics from servers, containers, and applications. In addition to providing a flexible query language (PromQL), and powerful visualization tools, it also provides an alerting mechanism that sends notifications when needed.</p>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<p>A machine that can run Ubuntu 22.04 ( or other LTS ).</p>
<p>You should also have basic administrative knowledge and an account that has sudo access on the above box.</p>
<h2 id="installation-1"><a class="header" href="#installation-1">Installation</a></h2>
<h3 id="update-the-system"><a class="header" href="#update-the-system">Update the system</a></h3>
<pre><code>sudo apt update &amp;&amp; sudo apt -y upgrade
</code></pre>
<h3 id="create-the-prometheus-user-account"><a class="header" href="#create-the-prometheus-user-account">Create the Prometheus User Account</a></h3>
<pre><code>sudo groupadd --system prometheus
sudo useradd -s /sbin/nologin --system -g prometheus prometheus
</code></pre>
<h3 id="create-directories"><a class="header" href="#create-directories">Create Directories</a></h3>
<p>These are for configuration files and libraries.</p>
<pre><code>sudo mkdir /etc/prometheus
sudo mkdir /var/lib/prometheus
</code></pre>
<h3 id="install-prometheus"><a class="header" href="#install-prometheus">Install Prometheus</a></h3>
<p>Now for the fun part!</p>
<p>The tarball used for this is the latest ( as of this writing ) LTS for Prometheus.  You can change it to be what you <a href="https://prometheus.io/download/#prometheus">need</a>.</p>
<pre><code>wget https://github.com/prometheus/prometheus/releases/download/v3.5.0/prometheus-3.5.0.linux-amd64.tar.gz
tar zvxf prometheus*.tar.gz
cd prometheus*/
sudo mv prometheus /usr/local/bin
sudo mv promtool /usr/local/bin
sudo chown prometheus:prometheus /usr/local/bin/prometheus
sudo chown prometheus:prometheus /usr/local/bin/promtool
sudo mv prometheus.yml /etc/prometheus
sudo chown prometheus:prometheus /etc/prometheus
sudo chown -R prometheus:prometheus /var/lib/prometheus

cd ..
rm -rf prom*
</code></pre>
<h3 id="configuring"><a class="header" href="#configuring">Configuring</a></h3>
<p>The configuration guide can be found <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/">over here</a>.  It will step you through most every option in the most confusing way possible.  I amd including a sample of my personal configuration in the hopes that a real world example makes more sense.</p>
<pre><code>sudo nano /etc/prometheus/prometheus.yml
</code></pre>
<p>Here is what my simple configuration file looks like:</p>
<pre><code># my global config
global:
  scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
  # scrape_timeout is set to the global default (10s).

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
           - alertmanager:9093

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  # - "first_rules.yml"
  # - "second_rules.yml"

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.
  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]
        labels:
          groups: 'monitors'
  - job_name: 'servers'
    static_configs:
      - targets:
          - 'atlas.faultycloud.lan:9182'
          - 'coeus.faultycloud.lan:9182'
          - 'gaia.faultycloud.lan:9182'
          - 'hyperion.faultycloud.lan:9182'
        labels:
          groups: 'win2022'
  - job_name: 'gitlab'
    static_configs:
      - targets:
          - '192.168.1.253:9090'
        labels:
          groups: 'development'
</code></pre>
<h3 id="run-at-startup"><a class="header" href="#run-at-startup">Run at Startup</a></h3>
<pre><code>sudo nano /etc/systemd/system/prometheus.service
</code></pre>
<p>with</p>
<pre><code>[Unit]
Description=Prometheus
Wants=network-online.target
After=network-online.target

[Service]
User=prometheus
Group=prometheus
Type=simple
ExecStart=/usr/local/bin/prometheus \
    --config.file /etc/prometheus/prometheus.yml \
    --storage.tsdb.path /var/lib/prometheus/ 

[Install]
WantedBy=multi-user.target
</code></pre>
<pre><code>sudo systemctl daemon-reload
sudo systemctl enable prometheus
sudo systemctl start prometheus
sudo systemctl status prometheus
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="systems-and-application-notifications-with-alert-manager"><a class="header" href="#systems-and-application-notifications-with-alert-manager">Systems and Application Notifications with Alert Manager</a></h1>
<p>So you have Prometheus, the next step is AlertManager, which will notify you when an something goes awry.</p>
<h2 id="alertmanager"><a class="header" href="#alertmanager">AlertManager?</a></h2>
<p>The Alertmanager handles alerts sent by client applications such as the Prometheus server. It takes care of deduplicating, grouping, and routing them to the correct receiver integration such as email, PagerDuty, or OpsGenie. It also takes care of silencing and inhibition of alerts.</p>
<h2 id="prerequisites-1"><a class="header" href="#prerequisites-1">Prerequisites</a></h2>
<p>A machine that can run Ubuntu 22.04 ( or other LTS ).</p>
<p>You should also have basic administrative knowledge and an account that has sudo access on the above box.</p>
<h2 id="installation-2"><a class="header" href="#installation-2">Installation</a></h2>
<h3 id="update-the-system-1"><a class="header" href="#update-the-system-1">Update the system</a></h3>
<pre><code>sudo apt update &amp;&amp; sudo apt -y upgrade
</code></pre>
<h3 id="create-the-alertmanager-user-account"><a class="header" href="#create-the-alertmanager-user-account">Create the AlertManager User Account</a></h3>
<pre><code>sudo groupadd --system alertmanager
sudo useradd -s /sbin/nologin --system -g alertmanager alertmanager
</code></pre>
<h3 id="create-directories-1"><a class="header" href="#create-directories-1">Create Directories</a></h3>
<p>These are for configuration files and libraries.</p>
<pre><code>sudo mkdir /etc/alertmanager
sudo mkdir /var/lib/alertmanager
</code></pre>
<h3 id="install-alertmanager"><a class="header" href="#install-alertmanager">Install AlertManager</a></h3>
<p>Now for the fun part!</p>
<pre><code>// https://prometheus.io/download/#alertmanager
wget https://github.com/prometheus/alertmanager/releases/download/v0.28.1/alertmanager-0.28.1.linux-amd64.tar.gz
tar zvxf alertmanager*.tar.gz
cd alertmanager*/
sudo mv alertmanager /usr/local/bin
sudo mv amtool /usr/local/bin
sudo chown alertmanager:alertmanager /usr/local/bin/alertmanager
sudo chown alertmanager:alertmanager /usr/local/bin/amtool
sudo chown alertmanager:alertmanager /var/lib/alertmanager

sudo mv alertmanager.yml /etc/alertmanager

cd ..
rm -rf alert*
</code></pre>
<h3 id="run-at-startup-1"><a class="header" href="#run-at-startup-1">Run at Startup</a></h3>
<pre><code>sudo nano /etc/systemd/system/alertmanager.service
</code></pre>
<p>with</p>
<pre><code>[Unit]
Description=AlertManager
Wants=network-online.target
After=network-online.target

[Service]
User=alertmanager
Group=alertmanager
Type=simple
ExecStart=/usr/local/bin/alertmanager \
    --config.file /etc/alertmanager/alertmanager.yml \
    --storage.path=/var/lib/alertmanager

[Install]
WantedBy=multi-user.target
</code></pre>
<pre><code>sudo systemctl daemon-reload
sudo systemctl enable alertmanager
sudo systemctl start alertmanager
sudo systemctl status alertmanager
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="node-exporter"><a class="header" href="#node-exporter">Node Exporter</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="runbooks"><a class="header" href="#runbooks">Runbooks</a></h1>
<p>Runbooks are a way of documenting procedural Information Technology information that is repetitive in nature.</p>
<p>Most of the time, you see runbooks as a way of troubleshooting a problem, diagnosising an issue or a procedure.</p>
<p>This is a collection of the runbooks that I have decided to document for my area.</p>
<h2 id="table-of-contents"><a class="header" href="#table-of-contents">Table of Contents</a></h2>
<ul>
<li><a href="runbooks/postgresql_create_database_user.html">Create PostgreSQL Database and User</a></li>
</ul>
<h2 id="alerts"><a class="header" href="#alerts">Alerts</a></h2>
<ul>
<li><a href="runbooks/alerts/pending_apt_package_upgrades.html">Pending Apt Package Upgrades</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="create-user-for-postgresql"><a class="header" href="#create-user-for-postgresql">Create User for PostgreSQL</a></h1>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<h2 id="pre-requistes"><a class="header" href="#pre-requistes">Pre-Requistes</a></h2>
<ul>
<li>Access to login into database server via ssh.</li>
<li><code>sudo</code> access on database server</li>
</ul>
<h2 id="steps"><a class="header" href="#steps">Steps</a></h2>
<ol>
<li>Log into database server via SSH.</li>
<li>Sudo into the <code>postgres</code> user and execute the <code>psql</code> command line tool.
<ul>
<li><code>sudo -u postgres psql</code></li>
</ul>
</li>
<li>Create the user with and encrypted password:
<ul>
<li>We recommend using a long and complex password since the values will only be saved here and can be input into the target system at the same time.</li>
<li>The user name should reflect the database that they are primarily accessing.</li>
<li><code>CREATE USER db01 WITH ENCRYPTED PASSWORD 'R3@llyL0ngP@ssw0rd123456790';</code></li>
</ul>
</li>
<li>Grant the new user dbcreate privileges:
<ul>
<li><code>ALTER USER db01 CREATEDB;</code></li>
</ul>
</li>
</ol>
<h2 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h2>
<ul>
<li>If the target system can not log into the database after the database/user creation process, you can simply re-run the above steps to make sure to make sure that they are correct.</li>
<li>If the user is present, but the password has been forgotten, you may reset the password as follows:
<ul>
<li><code>ALTER USER db01_user WITH ENCRYPTED PASSWORD '3^On9D4p59^4';</code></li>
</ul>
</li>
</ul>
<h2 id="completion-and-verification"><a class="header" href="#completion-and-verification">Completion and Verification</a></h2>
<p>You can log into the target database from <code>callisto.lan</code> to verify if everything is setup correctly</p>
<pre><code>psql -h 'callisto.lan' -U 'db01' -d 'db01_prod'
</code></pre>
<p>It will prompt you for the password, which we have available and should provide.  If the login occurs, then the database/user/permissions should be okay.</p>
<h2 id="contacts"><a class="header" href="#contacts">Contacts</a></h2>
<p>Not Applicable</p>
<h2 id="appendix"><a class="header" href="#appendix">Appendix</a></h2>
<h3 id="changelog"><a class="header" href="#changelog">Changelog</a></h3>
<pre><code>* 2023/04/06 - Created</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
